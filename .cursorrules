# LocationKit Project Rules

> **IMPORTANT**: Before writing ANY location or weather related code, you MUST read `AGENTS.md` first.

---

## ğŸ“– Knowledge Reference

The complete LocationKit architecture, API reference, and code patterns are documented in:

**â†’ `AGENTS.md`** (Read this first!)

This file contains:
- Mental Model (architecture diagram)
- Core Concepts (Burst Cache, Smart Timestamp)
- Critical Rules (Facade usage, async/await, WeatherKit compliance)
- Code Patterns (UIKit, SwiftUI, Error Handling)
- Troubleshooting Checklists

---

## â›” Code Behavior Rules (HIGH PRIORITY)

### Rule 1: NO Direct CoreLocation Usage

```swift
// âŒ FORBIDDEN - Never write code like this:
import CoreLocation
let manager = CLLocationManager()
manager.requestWhenInUseAuthorization()
manager.startUpdatingLocation()

// âŒ FORBIDDEN - Never instantiate internal services:
let locationManager = LocationManager()
let geocoding = GeocodingService.shared
let weather = AppleWeatherService.shared
```

### Rule 2: USE LocationKit Facade ONLY

```swift
// âœ… ALWAYS use the Facade:
import LocationKitProject

let context = try await LocationKit.shared.fetchCameraContext(
    scene: .work,   // or .travel
    mode: .fast     // or .accurate
)

// âœ… Use convenience methods:
let workContext = try await LocationKit.shared.fetchWorkContext()
let travelContext = try await LocationKit.shared.fetchTravelContext()
let burstContext = try await LocationKit.shared.fetchBurstContext()
```

### Rule 3: ASYNC/AWAIT Required

```swift
// âŒ WRONG - No completion handlers exist:
LocationKit.shared.fetchContext { result in }  // Does not exist!

// âœ… CORRECT - Always use async/await:
Task {
    do {
        let context = try await LocationKit.shared.fetchCameraContext(scene: .work, mode: .fast)
    } catch {
        // Handle error
    }
}
```

### Rule 4: WeatherKit Attribution is MANDATORY

When displaying weather data, you MUST include Apple Weather attribution:

```swift
// âœ… REQUIRED - Always show attribution when displaying weather:
if let weather = context.raw.weather {
    // Show weather
    Text(context.display.weatherStr)
    
    // MANDATORY: Show Apple Weather logo
    if let logoURL = weather.attributionLogoURL {
        AsyncImage(url: logoURL).frame(height: 20)
    }
    
    // MANDATORY: Provide legal link access
    if let legalURL = weather.attributionURL {
        Link("", destination: legalURL)
    }
}
```

### Rule 5: Use Display Properties for UI

```swift
// âŒ WRONG - Manual formatting:
let title = "\(context.raw.address?.locality ?? ""), \(context.raw.address?.subLocality ?? "")"

// âœ… CORRECT - Use pre-formatted display properties:
titleLabel.text = context.display.title
subtitleLabel.text = context.display.subtitle
weatherLabel.text = context.display.weatherStr
timeLabel.text = context.display.timeStr
```

---

## ğŸ” Quick API Reference

```swift
// Entry Point
LocationKit.shared.fetchCameraContext(scene: LocationScene, mode: LocationMode) async throws -> CameraLocationContext

// Scenes
LocationScene.work    // Watermark camera
LocationScene.travel  // Travel camera

// Modes
LocationMode.fast     // 5s timeout
LocationMode.accurate // 15s timeout

// Return Type
CameraLocationContext
â”œâ”€â”€ display.title         // "Beijing, Chaoyang"
â”œâ”€â”€ display.subtitle      // "Sanlitun SOHO"
â”œâ”€â”€ display.weatherStr    // "Sunny 25Â°C"
â”œâ”€â”€ display.timeStr       // "2026-01-31 18:30:00"
â”œâ”€â”€ display.altitudeStr   // "50.0 m"
â”œâ”€â”€ display.coordinateStr // "39.9042Â°N, 116.4074Â°E"
â”œâ”€â”€ flags.isCache         // true if from cache
â”œâ”€â”€ flags.isMock          // true on simulator
â””â”€â”€ raw.weather?.attributionLogoURL  // Required for compliance!

// Cache Management
LocationKit.shared.clearCache()
LocationKit.shared.cacheStatus // (hasCache: Bool, lastTime: Date?)
```

---

## ğŸ“‹ Before You Code Checklist

When writing location/weather code, verify:

- [ ] I have read `AGENTS.md` for complete API documentation
- [ ] I am using `LocationKit.shared` (not direct CoreLocation)
- [ ] I am using `async/await` (not completion handlers)
- [ ] I am using `context.display.*` for UI binding
- [ ] I have included WeatherKit attribution (logo + legal link)
- [ ] I understand the burst cache behavior (20m/120s thresholds)

---

## ğŸ·ï¸ File Purpose

| File | Purpose |
|------|---------|
| `AGENTS.md` | Complete knowledge base (read this first) |
| `.cursorrules` | Quick rules and triggers (this file) |
| `README.md` | Public-facing documentation |